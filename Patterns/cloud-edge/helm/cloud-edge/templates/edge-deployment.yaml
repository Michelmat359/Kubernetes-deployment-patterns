{{- if .Values.edge.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "cloud-edge.fullname" . }}-edge-processing
  labels:
    {{- include "cloud-edge.labels" . | nindent 4 }}
    component: edge-processing
    tier: edge
spec:
  replicas: {{ .Values.edge.replicas }}
  selector:
    matchLabels:
      app: edge-processing
      component: edge
  template:
    metadata:
      labels:
        app: edge-processing
        component: edge
        {{- include "cloud-edge.labels" . | nindent 8 }}
    spec:
      {{- if .Values.edge.nodeSelector }}
      nodeSelector:
        {{- toYaml .Values.edge.nodeSelector | nindent 8 }}
      {{- end }}
      containers:
        # Contenedor principal: Edge Processing
        - name: edge-processor
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: ROS_DOMAIN_ID
              value: "{{ .Values.ros.domainId }}"
            - name: RMW_IMPLEMENTATION
              value: "{{ .Values.ros.rmwImplementation }}"
            - name: ROS_LOCALHOST_ONLY
              value: "0"
            - name: FASTRTPS_DEFAULT_PROFILES_FILE
              value: "/tmp/fastdds.xml"
            - name: NODE_NAME
              value: "edge_processor"
            - name: COMPONENT_TYPE
              value: "edge"
          command:
            - /bin/bash
            - -c
            - |
              cat > /tmp/fastdds.xml <<EOF
              <?xml version="1.0" encoding="UTF-8" ?>
              <profiles xmlns="http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles">
                  <participant profile_name="participant_profile" is_default_profile="true">
                      <rtps>
                          <builtin>
                              <discovery_config>
                                  <discoveryProtocol>SIMPLE</discoveryProtocol>
                                  <leaseDuration>
                                      <sec>20</sec>
                                  </leaseDuration>
                              </discovery_config>
                          </builtin>
                      </rtps>
                  </participant>
              </profiles>
              EOF
              
              source /opt/ros/{{ .Chart.AppVersion }}/setup.bash
              echo "Starting Edge Processing Node..."
              ros2 run {{ .Values.edge.component.rosPackage }} {{ .Values.edge.component.rosExecutable }}
          ports:
            - name: ros-dds
              containerPort: 7400
              protocol: UDP
            - name: ros-discovery
              containerPort: 7401
              protocol: UDP
          resources:
            {{- toYaml .Values.edge.resources | nindent 12 }}
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - "ros2 node list | grep -q listener || exit 1"
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

        {{- if .Values.loadGenerator.enabled }}
        # Contenedor sidecar: Load Generator
        - name: load-generator
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          env:
            - name: ROS_DOMAIN_ID
              value: "{{ .Values.ros.domainId }}"
            - name: RMW_IMPLEMENTATION
              value: "{{ .Values.ros.rmwImplementation }}"
            - name: ROS_LOCALHOST_ONLY
              value: "0"
            - name: MESSAGE_RATE
              value: "{{ .Values.loadGenerator.messageRate }}"
            - name: TOPIC_NAME
              value: "{{ .Values.loadGenerator.topic }}"
          command:
            - /bin/bash
            - -c
            - |
              source /opt/ros/{{ .Chart.AppVersion }}/setup.bash
              # Instalar dependencias si es necesario
              apt-get update -qq && apt-get install -y -qq python3-pip > /dev/null 2>&1 || true
              echo "Starting Load Generator..."
              python3 /scripts/{{ .Values.loadGenerator.scriptPath }}
          volumeMounts:
            - name: load-sim
              mountPath: /scripts
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
        {{- end }}

      volumes:
        {{- if .Values.loadGenerator.enabled }}
        - name: load-sim
          configMap:
            name: {{ include "cloud-edge.fullname" . }}-load-sim
            defaultMode: 0755
        {{- end }}
      restartPolicy: Always
{{- end }}